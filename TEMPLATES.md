# sendAFD Templates
This document provides an overview of how email templating works in sendAFD. For more information about general usage, see README.md.

## Email structure
sendAFD uses the python [email](https://docs.python.org/3/library/email.html) package to generate a [MIME-format](https://en.wikipedia.org/wiki/MIME) email message. By default, a multipart email is generated with Content-Type of "multipart/alternative", including a "Content-Type: text/plain" part containing the plaintext Area Forecast Discussion generated by the NWS and a "Content-Type: text/html" part containing the html email generated by sendAFD's templating functionality. If the `-p` flag is used, only a single part email is generated, with "Content-Type: text/plain".

## Template format
sendAFD uses the [jinja](https://jinja.palletsprojects.com/en/3.1.x/) templating engine. The default template, located at `templates/default_email_templates`, provides an example of template syntax. Templates are used to generate the email's body section, so email header information is not included in the template.

### afd object
An afd object is passed to the template when it is rendered. The following public attributes are therefore available to use in the template:

#### afd.product_id
The unique NWS product id assigned to the Area Forecast Discussion. This can be used for debugging purposes or to fetch the raw AFD directly from the NWS API.

#### afd.issuing_office
Four letter code representing the NWS office that issued the AFD

#### afd.issuance_time
datetime object representing the date and time when the AFD was issued by NWS.

#### afd.raw_text
Raw text form of the AFD, as formatted by the NWS

#### afd.cleaned_text
Raw text without newlines in paragraphs so the email has a max line length of 78 characters (per RFC 5322), instead of
the 68 character line length used by the NWS. 

#### afd.sections
List of AreaForecastDiscussion.Section objects, representing sections in the original AFD demarcated by "&&" characters. See below for attributes of each object in this list

#### afd.Section.name
Name of the section parsed by searching for headers demarcated like ".Header name..."

#### afd.Section.body
Body text of the section, with section header and any subsections removed.

#### afd.Section.raw_section
Raw text of the section, including any header and subsections

#### afd.Section.subsections
List of subsections demarcated by the presence of additional headers within each section.

#### afd.Section.Subsection.name
Name of the subsection parsed by searching for headers demarcated like ".Header name..."

#### afd.Section.Subsection.body
Body text of the section, with subsection header removed.

#### afd.Section.Subsection.raw_subsection
Raw text of the section, including any header.

#### afd.header
Section object that duplicated the first section in afd.sections

#### afd.footer
Section object that duplicated the last section in afd.sections

### afd_json object
When the template is rendered with the `-w` flag, the NWS API JSON response containing the area forecast discussion is passed to the template and made available as afd_json. See [the NWS API documentation](https://www.weather.gov/documentation/services-web-api#/default/product) for a description of the JSON response.

## Template locations
sendAFD searches for templates in the `templates` subdirectory. Any custom templates you wish to use should be located here.

## Troubleshooting
Use of -f and -d flags for testing/troubleshooting.

## Bugs
Parsing of sections and subsections is not 100% reliable due to inconsistencies in how each NWS office formats their AFDs. The NWS does not enforce a standard, machine readable format for structuring the Area Forecast Discussion, so sendAFD's parsing and your template may be broken by formatting/style differences between offices or errors in data entry. While sendAFD tries to maintain greatest compatibility with the output of multiple forecast offices, the nature of how AFDs are published makes some errors inevitable. Please report any bugs at 